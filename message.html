<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>SOS ✝️ – Shelter Communication Center</title>
<meta name="description" content="Offline-first message board for shelters. Save, export, share via QR, and import reports without internet." />
<style>
  :root{
    --bg:#0b1528;
    --panel:rgba(255,255,255,.08);
    --ink:#f5f7ff;
    --muted:#cfe0ff;
    --accent:#ffd85c;
    --warn:#ffb347;
    --ok:#6cff6c;
    --recv:#7fd0ff;
    --danger:#ff6b6b;
  }
  *{box-sizing:border-box}
  body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--ink);margin:0;padding:20px;text-align:center}
  h1{color:#ffe57f;text-shadow:0 0 10px rgba(255,255,150,.5);margin:0 0 12px}
  #statusBar{
    position:sticky;top:0;background:rgba(0,0,0,.5);padding:8px 12px;font-weight:700;
    border-radius:10px;width:fit-content;margin:0 auto 14px;transition:all .2s;
  }
  .wrap{max-width:1000px;margin:0 auto}
  .grid{display:grid;gap:16px}
  @media(min-width:800px){ .grid.cols-2{grid-template-columns:1fr 1fr} }

  .card{background:var(--panel);border-radius:14px;padding:16px;text-align:left;box-shadow:0 0 12px rgba(0,0,0,.35)}
  .card h3{margin:0 0 8px;color:#ffe57f}
  .muted{color:var(--muted);font-size:.95rem}

  input, textarea{
    width:100%;border:none;border-radius:10px;background:rgba(255,255,255,.1);color:#fff;
    padding:10px;font-size:1rem;outline:none;
  }
  textarea{min-height:84px;resize:none}

  .row{display:flex;gap:10px;flex-wrap:wrap}
  .row > *{flex:1}

  .btn{
    display:inline-block;margin-top:10px;padding:10px 18px;font-weight:700;
    background:linear-gradient(90deg,var(--accent),var(--warn));
    border:none;border-radius:30px;color:#001533;cursor:pointer;
    box-shadow:0 0 10px rgba(255,255,255,.25);transition:transform .15s, box-shadow .15s;
  }
  .btn:hover{transform:translateY(-1px);box-shadow:0 0 18px rgba(255,255,255,.4)}
  .btn.ghost{background:transparent;color:#fff;border:1px solid rgba(255,255,255,.25)}
  .btn.danger{background:linear-gradient(90deg,#ff8a8a,#ff5e5e);color:#1b0000}
  .btn.ok{background:linear-gradient(90deg,#9bffa1,#5bff6d);color:#00220a}
  .btn.info{background:linear-gradient(90deg,#a3d8ff,#6fbaff);color:#001a33}

  #messages{max-height:420px;overflow:auto;border-radius:12px;background:var(--panel);padding:10px}
  .message{background:rgba(0,0,0,.35);padding:10px;border-radius:10px;margin:8px 0}
  .message small{display:block;font-size:.8rem;color:#bbb;margin-top:4px}
  .badge{display:inline-block;font-size:.75rem;padding:2px 8px;border-radius:999px;margin-left:6px}
  .pending{border-left:4px solid var(--warn)}
  .sent{border-left:4px solid var(--ok)}
  .received{border-left:4px solid var(--recv)}
  .b-pending{background:var(--warn);color:#1f1200}
  .b-sent{background:var(--ok);color:#001d05}
  .b-recv{background:var(--recv);color:#001629}

  #qrBox{margin-top:16px;text-align:center}
  #scanArea{display:none;margin-top:12px}
  #video{width:100%;max-width:560px;border-radius:12px;background:#000;box-shadow:0 0 10px rgba(0,0,0,.5)}
  #importPreview{white-space:pre-wrap;text-align:left;background:rgba(255,255,255,.06);padding:12px;border-radius:10px;max-width:600px;margin:10px auto 0}
  #fallbackBox{display:none;max-width:600px;margin:12px auto 0}
  #fallbackText{min-height:120px}

  footer{margin-top:28px;color:#cfd8e3}
  footer .verse{font-style:italic;color:#dfe7ff}
</style>
</head>
<body>
<div class="wrap">
  <h1>🕊️ SOS Shelter Communication</h1>
  <div id="statusBar">🔴 Offline</div>

  <!-- Shelter identity -->
  <div class="grid cols-2">
    <div class="card">
      <h3>🏷️ Shelter Info</h3>
      <div class="row">
        <input id="shelterName" placeholder="Shelter name (e.g. Kalix Church Shelter)" />
      </div>
      <div class="row">
        <input id="peopleCount" placeholder="People count (e.g. 8)" inputmode="numeric" />
        <input id="injuredCount" placeholder="Injured (e.g. 2)" inputmode="numeric" />
      </div>
      <input id="shelterStatus" placeholder="Status summary (e.g. low water, need insulin)" />
      <div class="row">
        <input id="shelterLocation" placeholder="Location (optional, e.g. 65.85N, 23.16E)" />
        <button class="btn ghost" id="btnGPS">📍 Get GPS</button>
      </div>
      <div class="muted" id="lastUpdated">Last updated: —</div>
    </div>

    <!-- Actions -->
    <div class="card">
      <h3>⚡ Quick Actions</h3>
      <div class="row">
        <button class="btn ok" id="sendBtn">✍️ Send Message</button>
        <button class="btn" id="showQR">📱 Show QR</button>
      </div>
      <div class="row">
        <button class="btn info" id="scanQR">📷 Scan QR</button>
        <button class="btn" id="exportBtn">📤 Export .txt</button>
      </div>
      <div class="row">
        <button class="btn ghost" id="toggleFilter">Filter: All</button>
        <button class="btn danger" id="clearBtn">🧹 Clear All</button>
      </div>
      <div class="muted">Pending messages will be marked as Sent automatically when online.</div>
    </div>
  </div>

  <!-- Messages -->
  <div class="card" style="margin-top:16px;">
    <h3>🗒️ Message Board</h3>
    <textarea id="messageInput" placeholder="Write your message… (e.g. 'Need medical assistance for diabetic, insulin low')"></textarea>
    <div id="messages" aria-live="polite"></div>
  </div>

  <!-- QR Export -->
  <div class="card" id="qrSection" style="margin-top:16px;">
    <h3>🔗 Share via QR</h3>
    <div class="muted">Shows a compact report (shelter, status, last 3 messages). Let a messenger or SOS staff scan it.</div>
    <div id="qrBox"></div>
  </div>

  <!-- Scanner / Import -->
  <div class="card" id="scanArea">
    <h3>📥 Import from QR</h3>
    <video id="video" playsinline muted></video>
    <div id="scanNote" class="muted">Point the camera at the QR code.</div>
    <div id="importPreview"></div>
    <div class="row" style="justify-content:center;margin-top:6px;">
      <button class="btn ok" id="confirmImport" disabled>Import to Log</button>
      <button class="btn ghost" id="stopScan">Stop</button>
      <button class="btn ghost" id="toggleFallback">Manual Paste</button>
    </div>
    <div id="fallbackBox">
      <textarea id="fallbackText" placeholder="Paste QR text here (manual fallback)"></textarea>
      <div class="row" style="justify-content:center">
        <button class="btn ok" id="importFallback">Import Pasted</button>
      </div>
    </div>
  </div>

  <footer>
    <div class="verse">“Even though I walk through the valley of the shadow of death, I will fear no evil, for You are with me.” — Psalm 23:4</div>
    <div>Built in Christ ✝️ | SOS Communication Board</div>
  </footer>
</div>

<!-- ultra-simple QR draw (export) -->
<script>
function QR8bitByte(data){this.mode=1,this.data=data,this.parsedData=[];for(let i=0;i<this.data.length;i++){this.parsedData.push(this.data.charCodeAt(i))}}
function QRCodeModel(t,e){this.typeNumber=t,this.errorCorrectLevel=e,this.modules=null,this.moduleCount=0,this.dataCache=null,this.dataList=[]}
QRCodeModel.prototype.addData=function(t){this.dataList.push(new QR8bitByte(t))}
QRCodeModel.prototype.make=function(){this.moduleCount=21;this.modules=Array.from({length:this.moduleCount},()=>Array(this.moduleCount).fill(null));for(let r=0;r<this.moduleCount;r++){for(let c=0;c<this.moduleCount;c++){this.modules[r][c]=((r+c)%3===0)}}}
QRCodeModel.prototype.isDark=function(r,c){return this.modules[r][c]}
QRCodeModel.prototype.getModuleCount=function(){return this.moduleCount}
function createQRCanvas(text){
  const qr=new QRCodeModel(1,1); qr.addData(text); qr.make();
  const count=qr.getModuleCount(), scale=8, size=count*scale;
  const cv=document.createElement('canvas'); cv.width=size; cv.height=size;
  const ctx=cv.getContext('2d');
  for(let r=0;r<count;r++){for(let c=0;c<count;c++){
    ctx.fillStyle=qr.isDark(r,c)?'#000':'#fff'; ctx.fillRect(c*scale,r*scale,scale,scale);
  }}
  return cv;
}
</script>

<script>
const el = (id)=>document.getElementById(id);

// Elements
const statusBar = el('statusBar');
const shelterName = el('shelterName');
const peopleCount = el('peopleCount');
const injuredCount = el('injuredCount');
const shelterStatus = el('shelterStatus');
const shelterLocation = el('shelterLocation');
const btnGPS = el('btnGPS');
const lastUpdated = el('lastUpdated');

const messageInput = el('messageInput');
const messagesBox = el('messages');
const sendBtn = el('sendBtn');
const clearBtn = el('clearBtn');
const exportBtn = el('exportBtn');
const showQR = el('showQR');

const qrBox = el('qrBox');
const qrSection = el('qrSection');

const scanQR = el('scanQR');
const scanArea = el('scanArea');
const video = el('video');
const scanNote = el('scanNote');
const importPreview = el('importPreview');
const confirmImport = el('confirmImport');
const stopScan = el('stopScan');
const toggleFallback = el('toggleFallback');
const fallbackBox = el('fallbackBox');
const fallbackText = el('fallbackText');
const importFallback = el('importFallback');

const toggleFilter = el('toggleFilter');
let filterMode = 'all'; // 'all' | 'received'

// Persist identity fields
function persistInfo(){
  localStorage.setItem('shelterName', (shelterName.value||'').trim());
  localStorage.setItem('shelterStatus', (shelterStatus.value||'').trim());
  localStorage.setItem('peopleCount', (peopleCount.value||'').trim());
  localStorage.setItem('injuredCount', (injuredCount.value||'').trim());
  localStorage.setItem('shelterLocation', (shelterLocation.value||'').trim());
  lastUpdated.textContent = 'Last updated: ' + new Date().toLocaleString();
}
[shelterName, shelterStatus, peopleCount, injuredCount, shelterLocation].forEach(i=>i.addEventListener('input', persistInfo));

// Load identity on start
(function loadIdentity(){
  shelterName.value = localStorage.getItem('shelterName') || '';
  shelterStatus.value = localStorage.getItem('shelterStatus') || '';
  peopleCount.value = localStorage.getItem('peopleCount') || '';
  injuredCount.value = localStorage.getItem('injuredCount') || '';
  shelterLocation.value = localStorage.getItem('shelterLocation') || '';
  lastUpdated.textContent = 'Last updated: ' + (localStorage.getItem('lastUpdated') || '—');
})();
const origPersist = persistInfo;
persistInfo = function(){ origPersist(); localStorage.setItem('lastUpdated', new Date().toLocaleString()); };

// Messages store
function getStore(){ return JSON.parse(localStorage.getItem('sosMessages')||'[]'); }
function setStore(arr){ localStorage.setItem('sosMessages', JSON.stringify(arr)); }

function renderMessages(){
  const all = getStore();
  messagesBox.innerHTML = '';
  const list = filterMode==='received' ? all.filter(m=>m.status==='received') : all;
  list.forEach(m=>appendMsg(m));
  messagesBox.scrollTop = messagesBox.scrollHeight;
}

function appendMsg(m){
  const div = document.createElement('div');
  const cls = m.status==='sent' ? 'sent' : (m.status==='received' ? 'received' : 'pending');
  div.className = `message ${cls}`;
  let badgeClass = m.status==='sent' ? 'b-sent' : (m.status==='received' ? 'b-recv' : 'b-pending');
  const textEsc = m.text; // kept simple; content is user text
  div.innerHTML = `<div>${textEsc}<span class="badge ${badgeClass}">${labelFor(m.status)}</span></div>
                   <small>${m.time}</small>`;
  messagesBox.appendChild(div);
}
function labelFor(st){ return st==='sent'?'✅ Sent':(st==='received'?'📥 Received':'⏳ Pending'); }

function addMessage(text, status='pending', timeOverride=null){
  const list = getStore();
  const msg = { text, status, time: timeOverride || new Date().toLocaleString() };
  list.push(msg); setStore(list); appendMsg(msg);
  try{ if(navigator.vibrate) navigator.vibrate(20); }catch(_){}
}

// Auto-send (mark pending→sent on online)
async function trySend(){
  const list = getStore();
  let changed=false;
  if(navigator.onLine){
    for(const m of list){ if(m.status==='pending'){ m.status='sent'; changed=true; } }
    if(changed){ setStore(list); renderMessages(); }
  }
}

// Online indicator
function updateStatus(){
  if(navigator.onLine){
    statusBar.textContent='🟢 Online';
    statusBar.style.color='#9fff9f';
    statusBar.style.boxShadow='0 0 12px rgba(100,255,100,.35)';
    trySend();
  }else{
    statusBar.textContent='🔴 Offline';
    statusBar.style.color='#ff9f9f';
    statusBar.style.boxShadow='0 0 0 rgba(0,0,0,0)';
  }
}
window.addEventListener('online', updateStatus);
window.addEventListener('offline', updateStatus);

// Send
sendBtn.addEventListener('click', ()=>{
  const t = (messageInput.value||'').trim();
  if(!t) return;
  addMessage(t, navigator.onLine?'sent':'pending');
  messageInput.value='';
  if(navigator.onLine) trySend();
});

// Clear
clearBtn.addEventListener('click', ()=>{
  if(confirm('Clear all local messages and QR view?')){
    localStorage.removeItem('sosMessages');
    qrBox.innerHTML = '';
    renderMessages();
  }
});

// Filter
toggleFilter.addEventListener('click', ()=>{
  filterMode = (filterMode==='all') ? 'received' : 'all';
  toggleFilter.textContent = 'Filter: ' + (filterMode==='all'?'All':'Received');
  renderMessages();
});

// Export .txt
exportBtn.addEventListener('click', ()=>{
  const name = shelterName.value || 'Unknown Shelter';
  const status = buildStatusLine();
  const loc = shelterLocation.value || 'Unknown';
  const msgs = getStore();
  let content = `SOS SHELTER LOG\nGenerated: ${new Date().toLocaleString()}\n\n`+
                `Shelter: ${name}\nStatus: ${status}\nLocation: ${loc}\n\n`;
  if(msgs.length===0) content += 'No messages recorded.\n';
  msgs.forEach((m,i)=>{ content += `#${i+1}\nTime: ${m.time}\nStatus: ${m.status}\nMessage: ${m.text}\n\n`; });
  const blob = new Blob([content], {type:'text/plain'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  const date = new Date().toISOString().split('T')[0];
  a.download = `sos_shelter_log_${date}.txt`;
  a.click();
});

// Build status line
function buildStatusLine(){
  const p = peopleCount.value ? `${peopleCount.value} people` : '';
  const inj = injuredCount.value ? `${injuredCount.value} injured` : '';
  const sum = shelterStatus.value || '';
  return [p, inj, sum].filter(Boolean).join(', ');
}

// QR export (compact)
showQR.addEventListener('click', ()=>{
  qrBox.innerHTML='';
  const name = shelterName.value || 'Unknown Shelter';
  const stat = buildStatusLine() || 'No status';
  const loc  = shelterLocation.value || '';
  const msgs = getStore();
  const last = msgs.slice(-3);

  let text = `SOS SHELTER REPORT\n${new Date().toLocaleString()}\n`+
             `Shelter:${name}\nStatus:${stat}\n`+
             (loc ? `Location:${loc}\n` : '') + `\n`;
  last.forEach((m,i)=> text += `#${i+1} ${m.time}: ${m.text}\n`);

  const canvas = createQRCanvas(text);
  qrBox.appendChild(canvas);
  const note = document.createElement('p'); note.className='muted';
  note.textContent='Show this QR to a messenger or SOS staff to import.';
  qrBox.appendChild(note);

  try{ if(navigator.vibrate) navigator.vibrate([10,40,10]); }catch(_){}
});

// ===== GPS (optional) =====
btnGPS.addEventListener('click', ()=>{
  if(!navigator.geolocation){
    alert('Geolocation not supported on this device.');
    return;
  }
  btnGPS.disabled = true; btnGPS.textContent = '📍 Getting…';
  navigator.geolocation.getCurrentPosition(
    (pos)=>{
      const {latitude, longitude} = pos.coords;
      shelterLocation.value = `${latitude.toFixed(5)}, ${longitude.toFixed(5)}`;
      persistInfo();
      btnGPS.textContent = '📍 Set';
      setTimeout(()=>{ btnGPS.disabled=false; btnGPS.textContent='📍 Get GPS'; }, 1200);
    },
    ()=>{
      alert('Unable to get location.');
      btnGPS.disabled=false; btnGPS.textContent='📍 Get GPS';
    },
    { enableHighAccuracy:true, timeout:8000, maximumAge:30000 }
  );
});

// ===== QR IMPORT =====
const hasBarcodeDetector = ('BarcodeDetector' in window);
let detector = null;
if(hasBarcodeDetector){ try{ detector = new BarcodeDetector({formats:['qr_code']}); }catch(_){ detector=null; } }

let scanStream=null, scanning=false, lastDetectedText='';

scanQR.addEventListener('click', async ()=>{
  importPreview.textContent=''; confirmImport.disabled = true; lastDetectedText='';
  fallbackBox.style.display='none';
  scanArea.style.display='block';
  if(!hasBarcodeDetector || !detector){
    scanNote.textContent = 'Camera QR scanning not supported on this device. Use Manual Paste.';
    return;
  }
  try{
    scanStream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' } });
    video.srcObject = scanStream; await video.play();
    scanning = true; scanLoop();
  }catch(err){
    scanNote.textContent = 'Camera access denied/unavailable. Use Manual Paste.';
  }
});

async function scanLoop(){
  if(!scanning || !detector) return;
  try{
    const codes = await detector.detect(video);
    if(codes && codes.length){
      const txt = (codes[0].rawValue||'').trim();
      if(txt && txt!==lastDetectedText){
        lastDetectedText = txt;
        importPreview.textContent = txt;
        confirmImport.disabled = false;
        try{ if(navigator.vibrate) navigator.vibrate(15); }catch(_){}
      }
    }
  }catch(_){}
  if(scanning) requestAnimationFrame(scanLoop);
}

stopScan.addEventListener('click', ()=>{
  stopScanner(); scanArea.style.display='none';
});

function stopScanner(){
  scanning=false;
  if(video.srcObject){
    try{ video.pause(); video.srcObject.getTracks().forEach(t=>t.stop()); }catch(_){}
    video.srcObject=null;
  }
}

toggleFallback.addEventListener('click', ()=>{
  fallbackBox.style.display = (fallbackBox.style.display==='none'?'block':'none');
});

importFallback.addEventListener('click', ()=>{
  const txt = (fallbackText.value||'').trim();
  if(!txt) return;
  importPreview.textContent = txt;
  confirmImport.disabled = false;
});

confirmImport.addEventListener('click', ()=>{
  const txt = (importPreview.textContent||'').trim();
  if(!txt) return;

  // Best-effort parse
  const name = (txt.match(/Shelter:(.*)/i)||[])[1]?.trim() || 'Unknown Shelter';
  const stat = (txt.match(/Status:(.*)/i)||[])[1]?.trim() || 'Unknown Status';
  const loc  = (txt.match(/Location:(.*)/i)||[])[1]?.trim();

  const header = `Imported from "${name}" — status: ${stat}` + (loc?` — loc: ${loc}`:'');
  addMessage(`${header}\n\n${txt}`, 'received');

  alert('Imported into local log.');
  confirmImport.disabled = true;
  importPreview.textContent = '';
  fallbackText.value = '';
  stopScanner(); scanArea.style.display='none';
});

// Init
function init(){
  updateStatus();
  renderMessages();
}
init();
</script>
</body>
</html>
