<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ›¡ï¸ SOS â€“ Shelters & Map</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#0b1528" />
  <link rel="icon" type="image/png" href="public/sos_favicon.png" />

  <!-- Leaflet (cached after first online use) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous"></script>

  <!-- Shelters CSS -->
  <link rel="stylesheet" href="styles/shelters.css" />
</head>
<body>
  <!-- Header -->
  <div id="header-placeholder"></div>
  <script>
    fetch("includes/header.html").then(r=>r.text()).then(h=>{document.getElementById("header-placeholder").innerHTML=h});
  </script>

  <main class="wrap">
    <section class="topbar">
      <div class="summary">
        <h1>ğŸ—ºï¸ Shelters & Map</h1>
        <p class="muted">Find, add and coordinate shelters. Everything is stored locally and works offline.</p>
        <div class="chips">
          <span id="chipTotal" class="chip">0 shelters</span>
          <span id="chipUpdated" class="chip">Updated: â€”</span>
          <span id="chipNet" class="chip">ğŸ”´ Offline</span>
          <span id="chipVerse" class="chip verse" hidden>â€”</span>
        </div>
      </div>
      <div class="actions">
        <button id="btnMyPos" class="btn ghost">ğŸ“ My position</button>
        <button id="btnFaith" class="btn ghost">âœï¸ Faith mode: OFF</button>
        <button id="btnClearAll" class="btn danger">ğŸ§¹ Clear local</button>
      </div>
    </section>

    <section class="mapBox">
      <div id="map" class="map"></div>
      <div id="mapFallback" class="mapFallback" hidden>
        <p>ğŸŒŒ Map failed to load (Leaflet missing or first-time offline).<br/>List functions still work. Once youâ€™ve been online, the map is cached.</p>
      </div>
    </section>

    <!-- Filters -->
    <section class="filterBar">
      <button class="fbtn active" data-filter="all">ğŸ”„ All</button>
      <button class="fbtn" data-filter="open">ğŸŸ¢ Open</button>
      <button class="fbtn" data-filter="full">ğŸŸ  Full</button>
      <button class="fbtn" data-filter="damaged">ğŸ”´ Damaged</button>
      <button class="fbtn" data-filter="unknown">âšª Unknown</button>
    </section>

    <section class="panel grid">
      <div class="card">
        <h2>â• Add shelter</h2>
        <div class="row">
          <input id="sName" placeholder="Name (e.g., Kalix Church)"/>
        </div>
        <div class="row">
          <input id="sLat" placeholder="Latitude (e.g., 65.85300)" inputmode="decimal" />
          <input id="sLon" placeholder="Longitude (e.g., 23.15600)" inputmode="decimal" />
        </div>
        <div class="row">
          <select id="sStatus">
            <option value="open">ğŸŸ¢ Open</option>
            <option value="full">ğŸŸ  Full</option>
            <option value="damaged">ğŸ”´ Damaged</option>
            <option value="unknown">âšª Unknown</option>
          </select>
          <input id="sCapacity" placeholder="Capacity (optional)" inputmode="numeric" />
        </div>
        <textarea id="sNotes" placeholder="Notes (e.g., generator, water, medicine)â€¦"></textarea>
        <div class="row">
          <button id="btnAdd" class="btn ok">ğŸ’¾ Save</button>
          <button id="btnGPSFill" class="btn ghost">ğŸ“ Fill from GPS</button>
        </div>
        <small class="muted">Coordinates required. Use â€œFill from GPSâ€ when possible.</small>
      </div>

      <div class="card">
        <h2>ğŸ“‹ Your shelters</h2>
        <div class="row" style="margin-bottom:8px">
          <button id="btnShareQR" class="btn">ğŸ“¤ Share (QR)</button>
          <button id="btnScanQR" class="btn ghost">ğŸ“· Scan QR</button>
        </div>
        <div id="shelterList" class="list"></div>

        <!-- QR Export -->
        <div id="qrPanel" class="qrPanel" hidden>
          <h3>ğŸ”— QR Export</h3>
          <div class="row">
            <select id="qrSelect">
              <option value="all">All shelters</option>
            </select>
            <button id="btnMakeQR" class="btn ok">ğŸ§¾ Make QR</button>
          </div>
          <div id="qrBox" class="qrBox"></div>
          <div class="row" style="justify-content:center">
            <button id="btnCloseQR" class="btn ghost">Close</button>
            <button id="btnCopyText" class="btn">ğŸ“‹ Copy text</button>
          </div>
          <pre id="qrText" class="qrText" hidden></pre>
          <small class="muted">If QR isnâ€™t supported: show/copy this text to the recipient.</small>
        </div>

        <!-- QR Import -->
        <div id="scanPanel" class="scanPanel" hidden>
          <h3>ğŸ“¥ QR Import</h3>
          <video id="video" playsinline muted></video>
          <div class="row" style="justify-content:center;margin-top:6px;">
            <button id="btnStartScan" class="btn ok">â–¶ï¸ Start camera</button>
            <button id="btnStopScan" class="btn ghost">â¹ï¸ Stop</button>
            <button id="btnManual" class="btn">âŒ¨ï¸ Paste text</button>
          </div>
          <textarea id="manualText" class="manualText" placeholder="Paste QR text hereâ€¦" hidden></textarea>
          <div class="row" style="justify-content:center">
            <button id="btnImportManual" class="btn ok" hidden>ğŸ“¥ Import</button>
          </div>
          <div id="importPreview" class="importPreview"></div>
        </div>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <div id="footer-placeholder"></div>
  <script>
    fetch("includes/footer.html").then(r=>r.text()).then(f=>{document.getElementById("footer-placeholder").innerHTML=f});
  </script>

  <!-- Shelters JS -->
  <script src="scripts/shelters.js"></script>

  <!-- Service Worker -->
  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js")
        .then(()=>console.log("ğŸŸ¢ SW registered for shelters"))
        .catch(err=>console.warn("SW failed:", err));
    }
  </script>
</body>
</html>
